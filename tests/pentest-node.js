/**
 * Pen Tests del Validator Node (HTTP)
 * =====================================
 * Levanta el nodo en puerto 14889 y lo ataca.
 *
 * node tests/pentest-node.js
 */

const http = require("node:http");
const { startValidatorNode } = require("../packages/network/dist/validator.js");
const { generateKeypair, createToken } = require("../packages/core/dist/index.js");

let total = 0, passed = 0, failed = 0;
const PORT = 14889;
const BASE = `http://localhost:${PORT}`;

async function req(method, path, body = null) {
  return new Promise((resolve) => {
    const opts = {
      hostname: "localhost", port: PORT, path,
      method,
      headers: body ? { "Content-Type": "application/json" } : {},
    };
    const r = http.request(opts, (res) => {
      let data = "";
      res.on("data", d => data += d);
      res.on("end", () => {
        try { resolve({ status: res.statusCode, body: JSON.parse(data) }); }
        catch { resolve({ status: res.statusCode, body: data }); }
      });
    });
    r.on("error", () => resolve({ status: 0, body: null }));
    if (body) r.write(JSON.stringify(body));
    r.end();
  });
}

function assert(cond, msg) { if (!cond) throw new Error(msg ?? "Assertion failed"); }
function assertEq(a, b, msg) { if (a !== b) throw new Error(msg ?? `Expected ${b}, got ${a}`); }

async function test(name, fn) {
  total++;
  try {
    await fn();
    console.log(`  ‚úÖ ${name}`);
    passed++;
  } catch (e) {
    console.log(`  ‚ùå ${name}: ${e.message}`);
    failed++;
  }
}

async function run() {
  // Limpiar state del nodo anterior
  const fs   = require("node:fs");
  const path = require("node:path");
  const os   = require("node:os");
  const db   = path.join(os.homedir(), ".soulprint", "node", "nullifiers.json");
  if (fs.existsSync(db)) fs.writeFileSync(db, "{}");

  console.log("üî• Soulprint ‚Äî Pen Tests del Validator Node\n");
  console.log(`   Levantando nodo en puerto ${PORT}...`);

  const server = startValidatorNode(PORT);
  await new Promise(r => setTimeout(r, 300));  // esperar arranque

  // ‚îÄ‚îÄ 1. Endpoints b√°sicos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  console.log("\nüìã 1. Endpoints b√°sicos");

  await test("GET /info responde 200", async () => {
    const r = await req("GET", "/info");
    assertEq(r.status, 200);
    assert(r.body.node_did?.startsWith("did:key:z"), "node_did v√°lido");
    assert(r.body.protocol === "sip/0.1", "protocol correcto");
  });

  await test("GET /404 responde 404", async () => {
    const r = await req("GET", "/nonexistent");
    assertEq(r.status, 404);
  });

  await test("GET /nullifier/0xnone responde 404 (no registrado)", async () => {
    const r = await req("GET", "/nullifier/0xdeadbeef1234");
    assertEq(r.status, 404);
    assert(!r.body.registered);
  });

  // ‚îÄ‚îÄ 2. Ataques HTTP b√°sicos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  console.log("\nüìã 2. Ataques HTTP b√°sicos");

  await test("POST /verify sin body ‚Üí 400", async () => {
    const r = await req("POST", "/verify", {});
    assertEq(r.status, 400);
    assert(r.body.error?.includes("Missing"), `Error: ${r.body.error}`);
  });

  await test("POST /verify con campos no-string ‚Üí 400", async () => {
    const r = await req("POST", "/verify", { spt: 123, zkp: [] });
    assertEq(r.status, 400);
  });

  await test("POST /verify con token inv√°lido ‚Üí 401", async () => {
    const r = await req("POST", "/verify", { spt: "token_invalido", zkp: "zkp_invalido" });
    assertEq(r.status, 401);
  });

  await test("POST /verify con token v√°lido pero ZKP inv√°lido ‚Üí 400", async () => {
    const kp    = generateKeypair();
    const token = createToken(kp, "0xnull", ["FaceMatch"]);
    const r = await req("POST", "/verify", { spt: token, zkp: "zkp_falso_base64" });
    assertEq(r.status, 400);
  });

  await test("GET /nullifier con caracteres inv√°lidos ‚Üí rechazado (400 o error de cliente)", async () => {
    try {
      // Node.js HTTP rechaza URIs malformadas antes de llegar al servidor
      // Eso tambi√©n es protecci√≥n v√°lida ‚Äî el ataque nunca llega
      const r = await req("GET", "/nullifier/" + encodeURIComponent("'; DROP TABLE--"));
      assert(r.status === 400 || r.status === 404, `Status: ${r.status}`);
    } catch (e) {
      // Error de cliente tambi√©n es protecci√≥n v√°lida
      assert(true, "Rechazado por el cliente HTTP");
    }
  });

  await test("GET /nullifier con path traversal ‚Üí 400 o 404", async () => {
    const r = await req("GET", "/nullifier/../../../../../etc/passwd");
    assert(r.status === 400 || r.status === 404, `Status: ${r.status}`);
  });

  await test("M√©todo no permitido en /info ‚Üí 404", async () => {
    const r = await req("POST", "/info");
    assertEq(r.status, 404);
  });

  // ‚îÄ‚îÄ 3. DoS attempts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  console.log("\nüìã 3. DoS Attempts");

  await test("Body > 64KB ‚Üí rechazado", async () => {
    return new Promise((resolve) => {
      const opts = {
        hostname: "localhost", port: PORT, path: "/verify",
        method: "POST",
        headers: { "Content-Type": "application/json" },
      };
      const r = http.request(opts, (res) => {
        // Esperar respuesta o que la conexi√≥n se cierre
        let data = "";
        res.on("data", d => data += d);
        res.on("end", () => {
          // El servidor puede cortar la conexi√≥n o responder 400
          resolve();
        });
      });
      r.on("error", () => resolve()); // conexi√≥n rota = bien
      // Enviar 70KB de datos
      r.write("{\"spt\":\"" + "a".repeat(70_000) + "\",\"zkp\":\"b\"}");
      r.end();
      try { assert(true); } catch(e) { throw e; }
    });
  });

  await test("Rate limit: 11+ requests/min ‚Üí 429", async () => {
    // Mandar 12 requests r√°pidos desde la misma IP
    // (IP local es siempre la misma)
    let got429 = false;
    const kp    = generateKeypair();
    const token = createToken(kp, "0xratelimit", ["FaceMatch"]);

    for (let i = 0; i < 12; i++) {
      const r = await req("POST", "/verify", { spt: token, zkp: "bad" });
      if (r.status === 429) { got429 = true; break; }
    }
    assert(got429, "Debe recibir 429 despu√©s de 10+ requests/min");
  });

  // ‚îÄ‚îÄ 4. Headers de seguridad ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  console.log("\nüìã 4. Security Headers");

  await test("Response incluye X-Content-Type-Options: nosniff", async () => {
    return new Promise((resolve, reject) => {
      http.get(`${BASE}/info`, (res) => {
        if (res.headers["x-content-type-options"] === "nosniff") resolve();
        else reject(new Error(`Header faltante: ${JSON.stringify(res.headers)}`));
        res.resume();
      }).on("error", reject);
    });
  });

  await test("Response incluye X-Frame-Options: DENY", async () => {
    return new Promise((resolve, reject) => {
      http.get(`${BASE}/info`, (res) => {
        if (res.headers["x-frame-options"] === "DENY") resolve();
        else reject(new Error("X-Frame-Options faltante"));
        res.resume();
      }).on("error", reject);
    });
  });

  await test("OPTIONS (CORS preflight) ‚Üí 204", async () => {
    return new Promise((resolve, reject) => {
      const r = http.request({ hostname: "localhost", port: PORT, path: "/verify", method: "OPTIONS" }, (res) => {
        if (res.statusCode === 204) resolve();
        else reject(new Error(`Status: ${res.statusCode}`));
        res.resume();
      });
      r.on("error", reject);
      r.end();
    });
  });

  // ‚îÄ‚îÄ Resultado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  server.close();

  console.log(`\n${"‚ïê".repeat(50)}`);
  console.log(`  Total:    ${total} pen tests`);
  console.log(`  Pasados:  ${passed} ‚úÖ`);
  console.log(`  Fallidos: ${failed} ${failed > 0 ? "‚ùå" : "‚úÖ"}`);
  console.log(`${"‚ïê".repeat(50)}\n`);
  process.exit(failed > 0 ? 1 : 0);
}

run().catch(err => { console.error("Fatal:", err); process.exit(1); });
