#!/usr/bin/env node
/**
 * deploy-registries.mjs
 * Deploy NullifierRegistry.sol + ReputationRegistry.sol â†’ Base Sepolia
 * Usage: ADMIN_PRIVATE_KEY=0x... node packages/network/scripts/deploy-registries.mjs
 */
import { ethers } from "ethers";
import { readFileSync, writeFileSync } from "fs";
import { join, dirname } from "path";
import { fileURLToPath } from "url";

const __dirname = dirname(fileURLToPath(import.meta.url));

const PRIVATE_KEY = process.env.ADMIN_PRIVATE_KEY
  ?? "0x0c85117778a68f7f4cead481dbc44695487fc4924b51eb6b6a07903262033a2b";
const RPC_URL = "https://sepolia.base.org";

// â”€â”€ Pre-compiled artifacts (generated by solc 0.8.24, optimizer 200 runs) â”€â”€â”€â”€
// Regenerate with: python3 scripts/compile-contracts.py
const NULLIFIER_ABI = JSON.parse(readFileSync(new URL("../src/blockchain/NullifierRegistry.abi.json", import.meta.url), "utf8"));
const NULLIFIER_BYTECODE = readFileSync(new URL("../src/blockchain/NullifierRegistry.bin", import.meta.url), "utf8").trim();
const REPUTATION_ABI = JSON.parse(readFileSync(new URL("../src/blockchain/ReputationRegistry.abi.json", import.meta.url), "utf8"));
const REPUTATION_BYTECODE = readFileSync(new URL("../src/blockchain/ReputationRegistry.bin", import.meta.url), "utf8").trim();

async function deploy() {
  console.log("\nğŸš€ Deploying NullifierRegistry + ReputationRegistry to Base Sepolia...\n");

  const provider = new ethers.JsonRpcProvider(RPC_URL);
  const wallet   = new ethers.Wallet(PRIVATE_KEY, provider);
  const superAdmin = wallet.address;

  const balance = await provider.getBalance(wallet.address);
  console.log(`  Deployer / superAdmin: ${superAdmin}`);
  console.log(`  Balance:               ${ethers.formatEther(balance)} ETH\n`);

  if (balance === 0n) {
    throw new Error("Deployer has 0 ETH â€” fund the wallet on Base Sepolia first");
  }

  // Load existing addresses
  const addressesPath = join(__dirname, "../src/blockchain/addresses.json");
  let addresses = { PeerRegistry: "0x452fb66159dFCfC13f2fD9627aA4c56886BfB15b" };
  try { addresses = JSON.parse(readFileSync(addressesPath, "utf8")); } catch {}

  const feeData = await provider.getFeeData();

  // â”€â”€ Deploy NullifierRegistry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  console.log("ğŸ“‹ Deploying NullifierRegistry...");
  const NullifierFactory = new ethers.ContractFactory(NULLIFIER_ABI, NULLIFIER_BYTECODE, wallet);
  const nullifierContract = await NullifierFactory.deploy(superAdmin, { gasPrice: feeData.gasPrice });
  console.log(`   tx: ${nullifierContract.deploymentTransaction()?.hash}`);
  await nullifierContract.waitForDeployment();
  const nullifierAddress = await nullifierContract.getAddress();
  console.log(`   âœ… NullifierRegistry: ${nullifierAddress}`);

  // â”€â”€ Deploy ReputationRegistry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  console.log("\nğŸ“‹ Deploying ReputationRegistry...");
  const ReputationFactory = new ethers.ContractFactory(REPUTATION_ABI, REPUTATION_BYTECODE, wallet);
  const feeData2 = await provider.getFeeData();
  const reputationContract = await ReputationFactory.deploy(superAdmin, { gasPrice: feeData2.gasPrice });
  console.log(`   tx: ${reputationContract.deploymentTransaction()?.hash}`);
  await reputationContract.waitForDeployment();
  const reputationAddress = await reputationContract.getAddress();
  console.log(`   âœ… ReputationRegistry: ${reputationAddress}`);

  // â”€â”€ Save addresses â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  addresses.NullifierRegistry  = nullifierAddress;
  addresses.ReputationRegistry = reputationAddress;
  writeFileSync(addressesPath, JSON.stringify(addresses, null, 2));
  console.log(`\nâœ… addresses.json updated:\n${JSON.stringify(addresses, null, 2)}\n`);

  return addresses;
}

deploy().catch(err => {
  console.error("\nâŒ Deploy failed:", err.message ?? err);
  process.exit(1);
});
