#!/usr/bin/env node
/**
 * deploy-peer-registry.mjs
 * Deploy PeerRegistry.sol ‚Üí Base Sepolia
 * Usage: node packages/network/scripts/deploy-peer-registry.mjs
 */
import { ethers } from "ethers";
import { readFileSync, writeFileSync, existsSync } from "fs";
import { join, dirname } from "path";
import { fileURLToPath } from "url";

const __dirname = dirname(fileURLToPath(import.meta.url));

const PRIVATE_KEY = process.env.ADMIN_PRIVATE_KEY
  ?? "0x0c85117778a68f7f4cead481dbc44695487fc4924b51eb6b6a07903262033a2b";
const RPC_URL = "https://sepolia.base.org";

const ABI = [{"anonymous": false, "inputs": [{"indexed": true, "internalType": "string", "name": "peerDid", "type": "string"}, {"indexed": false, "internalType": "string", "name": "peerId", "type": "string"}, {"indexed": false, "internalType": "string", "name": "multiaddr", "type": "string"}, {"indexed": false, "internalType": "uint256", "name": "score", "type": "uint256"}, {"indexed": true, "internalType": "address", "name": "registrant", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "timestamp", "type": "uint256"}], "name": "PeerRegistered", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "string", "name": "peerDid", "type": "string"}, {"indexed": true, "internalType": "address", "name": "removedBy", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "timestamp", "type": "uint256"}], "name": "PeerRemoved", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "string", "name": "peerDid", "type": "string"}, {"indexed": false, "internalType": "string", "name": "peerId", "type": "string"}, {"indexed": false, "internalType": "string", "name": "multiaddr", "type": "string"}, {"indexed": false, "internalType": "uint256", "name": "score", "type": "uint256"}, {"indexed": true, "internalType": "address", "name": "registrant", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "timestamp", "type": "uint256"}], "name": "PeerUpdated", "type": "event"}, {"inputs": [], "name": "getAllPeers", "outputs": [{"components": [{"internalType": "string", "name": "peerDid", "type": "string"}, {"internalType": "string", "name": "peerId", "type": "string"}, {"internalType": "string", "name": "multiaddr", "type": "string"}, {"internalType": "uint256", "name": "score", "type": "uint256"}, {"internalType": "uint256", "name": "lastSeen", "type": "uint256"}, {"internalType": "address", "name": "registrant", "type": "address"}], "internalType": "struct PeerRegistry.Peer[]", "name": "", "type": "tuple[]"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "string", "name": "peerDid", "type": "string"}], "name": "getPeer", "outputs": [{"internalType": "string", "name": "did", "type": "string"}, {"internalType": "string", "name": "peerId", "type": "string"}, {"internalType": "string", "name": "multiaddr", "type": "string"}, {"internalType": "uint256", "name": "score", "type": "uint256"}, {"internalType": "uint256", "name": "lastSeen", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "peerCount", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "string", "name": "peerDid", "type": "string"}, {"internalType": "string", "name": "peerId", "type": "string"}, {"internalType": "string", "name": "multiaddr", "type": "string"}, {"internalType": "uint256", "name": "score", "type": "uint256"}], "name": "registerPeer", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "string", "name": "peerDid", "type": "string"}], "name": "removePeer", "outputs": [], "stateMutability": "nonpayable", "type": "function"}];
const BYTECODE = "0x60808060405234610016576112fd908161001c8239f35b600080fdfe608080604052600436101561001357600080fd5b60003560e01c90816318e1b446146106ec575080632d62b8101461047257806358cf4ab6146103a3578063e81ea595146103445763f683d96c1461005657600080fd5b3461033f5760208060031936011261033f576004356001600160401b03811161033f57610087903690600401610d43565b906100a860ff6040518484823785818681016002815203019020541661114f565b60405182828237600381840190815281900384019020546001600160a01b031633036102e95760405182828237838184810160008152030190206100eb8161119b565b60016100f881830161119b565b6101046002830161119b565b6000600383015560006004830155600060058093015560405184848237858186810160038152030190206bffffffffffffffffffffffff60a01b8154169055604051848482378581868101600281520301902060ff198154169055806000905b6101ab575b5050508160405192839283378101600081520390207f7a1844fd4ac47b8d684f4e21ae1d078eddc670cb84f71c81da2e780ed9755b18604051924284523393a3005b8154808210156102e3576101d16101d86101c484610f22565b506040519283809261103d565b0382610dcb565b8781519101206101e9368888610dec565b888151910120146101fd5750810181610164565b60001991908281019081116102cd5761021861021f91610f22565b5091610f22565b9190916102a15761022f916111e4565b815480156102b757019161024283610f22565b6102a1576102508154610e32565b80610262575b50505055388080610169565b600092601f80831160011461027e57505050555b388080610256565b839161029a9186949585528b85209501901c8401868501610e6c565b5555610276565b634e487b7160e01b600052600060045260246000fd5b634e487b7160e01b600052603160045260246000fd5b634e487b7160e01b600052601160045260246000fd5b50610169565b60405162461bcd60e51b815260048101849052602860248201527f5065657252656769737472793a206f6e6c792072656769737472616e742063616044820152676e2072656d6f766560c01b6064820152608490fd5b600080fd5b3461033f57600036600319011261033f5760018054600090815b81811061037057602083604051908152f35b8060ff6103866103808794610f22565b50610f6f565b5416610393575b0161035e565b9261039d90611003565b9261038d565b3461033f57602036600319011261033f576004356001600160401b03811161033f5761041560206103db610447933690600401610d43565b91906103fd60ff6040518584823784818781016002815203019020541661114f565b826040519384928337810160008152030190206110d3565b80519060208101516104636040830151610455608060608601519501519360405197889760a0895260a0890190610d70565b908782036020890152610d70565b908582036040870152610d70565b91606084015260808301520390f35b3461033f57600036600319011261033f5760008060018054925b8381106106bd57506104b66104a083611012565b926104ae6040519485610dcb565b808452611012565b60209390601f19018460005b828110610680575050506000805b82811061059b5750505090604051928392818401828552835180915260408501928060408360051b8801019501936000905b83821061050f5787870388f35b918496819592949698508190603f198b820301855289519061056261055061054060c0855190808652850190610d70565b8585015184820387860152610d70565b60408401518382036040850152610d70565b91606080820151908301526080808201519083015260a0908160018060a01b039101511691015298019201920187969593919492610502565b8060ff6105ab6103808794610f22565b54166105b8575b016104d0565b6105c181610f22565b5087604051916000908054906105d682610e32565b918781169081156106675750600114610624575b5050600081528290030190209261061e9061060d61060782611003565b956110d3565b610617828a611029565b5287611029565b506105b2565b9150949392915060005288806000209460005b818110610652575061061e93949550829081019192936105ea565b865481850152949095019488948b9201610637565b60ff19168652505080151502830190508261061e6105ea565b60405161068c81610db0565b60006060808352808584015280604084015282015260006080820152600060a08201528282880101520185906104c2565b60ff6106cb61038083610f22565b54166106d9575b810161048c565b916106e48291611003565b9290506106d2565b3461033f57608036600319011261033f576004356001600160401b03811161033f5761071c903690600401610d43565b6024929192356001600160401b03811161033f5761073e903690600401610d43565b91604435906001600160401b03821161033f5761076160ff923690600401610d43565b9290958288823760208184810160028152030190205416158015610cbc575b6040519061078d82610db0565b61079836848a610dec565b82526107a5368787610dec565b602083019081526107b736868a610dec565b604084015260643560608401524260808401523360a0840152604051848a823760208186810160008152030190209083518051906001600160401b038211610af55761080d826108078654610e32565b86610e83565b602090601f8311600114610c545761083e929160009183610b5b575b50508160011b916000199060031b1c19161790565b82555b518051906001600160401b038211610af55761086d826108646001860154610e32565b60018601610e83565b602090601f8311600114610be25761089d929160009183610bd75750508160011b916000199060031b1c19161790565b60018201555b60408301518051906001600160401b038211610af5576108d3826108ca6002860154610e32565b60028601610e83565b602090601f8311600114610b665791806109079260059594600092610b5b5750508160011b916000199060031b1c19161790565b60028201555b606084015160038201556080840151600482015560a090930151920180546001600160a01b039093166001600160a01b031993841617905515610b0b5760015468010000000000000000811015610af55780600161096e9201600155610f22565b6102a1576001600160401b038311610af5576109948361098e8354610e32565b83610e83565b6000601f8411600114610a6557917f5e470fe5075ff86595fdd04ed22a47b3ae8fce8012410be25992acac22033010969798916109ed8580610a559796600091610a5a575b508160011b916000199060031b1c19161790565b90555b604051838382376020818581016002815203019020600160ff1982541617905560405183838237602081858101600381520301902090339082541617905581604051928392833781016000815203902094604051938493339842936064359387610eeb565b0390a3005b90508501358d6109d9565b601f198416908260005260206000209160005b818110610add5750917f5e470fe5075ff86595fdd04ed22a47b3ae8fce8012410be25992acac2203301098999a939186610a5597969410610ac3575b5050600184811b0190556109f0565b840135600019600387901b60f8161c191690558a80610ab4565b9192602060018192868f013581550194019201610a78565b634e487b7160e01b600052604160045260246000fd5b50807f464604c5464b0ee7aa71fa9ea7167e99832e5f4616dc6108fb93aebb7d30cb7b949596610a5592604051928392833781016000815203902094604051938493339842936064359387610eeb565b015190508d80610829565b90601f198316916002850160005260206000209260005b818110610bbf5750916001939185600597969410610ba6575b505050811b01600282015561090d565b015160001960f88460031b161c191690558c8080610b96565b92936020600181928786015181550195019301610b7d565b015190508c80610829565b9190600184016000526020600020906000935b601f1984168510610c39576001945083601f19811610610c20575b505050811b0160018201556108a3565b015160001960f88460031b161c191690558b8080610c10565b81810151835560209485019460019093019290910190610bf5565b90601f198316918560005260206000209260005b818110610ca45750908460019594939210610c8b575b505050811b018255610841565b015160001960f88460031b161c191690558c8080610c7e565b92936020600181928786015181550195019301610c68565b604051828882376003838201908152602090829003019020546001600160a01b031633146107805760405162461bcd60e51b815260206004820152603160248201527f5065657252656769737472793a206f6e6c79206f726967696e616c2072656769604482015270737472616e742063616e2075706461746560781b6064820152608490fd5b9181601f8401121561033f578235916001600160401b03831161033f576020838186019501011161033f57565b919082519283825260005b848110610d9c575050826000602080949584010152601f8019910116010190565b602081830181015184830182015201610d7b565b60c081019081106001600160401b03821117610af557604052565b90601f801991011681019081106001600160401b03821117610af557604052565b9291926001600160401b038211610af55760405191610e15601f8201601f191660200184610dcb565b82948184528183011161033f578281602093846000960137010152565b90600182811c92168015610e62575b6020831014610e4c57565b634e487b7160e01b600052602260045260246000fd5b91607f1691610e41565b818110610e77575050565b60008155600101610e6c565b9190601f8111610e9257505050565b610ebe926000526020600020906020601f840160051c83019310610ec0575b601f0160051c0190610e6c565b565b9091508190610eb1565b908060209392818452848401376000828201840152601f01601f1916010190565b929093610f0a606095610f189499989799608087526080870191610eca565b918483036020860152610eca565b9460408201520152565b600154811015610f595760016000527fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf60190600090565b634e487b7160e01b600052603260045260246000fd5b604051908160008254610f8181610e32565b93600191808316908115610fe75750600114610fa9575b505060209250600281520301902090565b9091506000526020906020600020906000915b858310610fd3575050505060209181013880610f98565b805487840152869450918301918101610fbc565b92505050602093915060ff191682528015150281013880610f98565b60001981146102cd5760010190565b6001600160401b038111610af55760051b60200190565b8051821015610f595760209160051b010190565b80546000939261104c82610e32565b918282526020936001916001811690816000146110b45750600114611073575b5050505050565b90939495506000929192528360002092846000945b8386106110a05750505050010190388080808061106c565b805485870183015294019385908201611088565b60ff19168685015250505090151560051b01019150388080808061106c565b906040516110e081610db0565b60a081936040516110f5816101d1818561103d565b835260405161110b816101d1816001860161103d565b6020840152604051611124816101d1816002860161103d565b60408401526003810154606084015260048101546080840152600501546000196001831b0116910152565b1561115657565b60405162461bcd60e51b815260206004820152601c60248201527f5065657252656769737472793a2070656572206e6f7420666f756e64000000006044820152606490fd5b6111a58154610e32565b90816111af575050565b81601f600093116001146111c1575055565b9080839182526111e0601f60208420940160051c840160018501610e6c565b5555565b908082146112c3576111f68154610e32565b906001600160401b038211610af557611219826112138554610e32565b85610e83565b600090601f83116001146112585761124992916000918361124d5750508160011b916000199060031b1c19161790565b9055565b015490503880610829565b815260208082208483528183209291601f1985169083905b8282106112aa575050908460019594939210611291575b505050811b019055565b015460001960f88460031b161c19169055388080611287565b8495819295850154815560018091019601940190611270565b505056fea2646970667358221220f0613ca8a368d6bba990c665a67e201f27fc2312fd4b9476168ecd6973eda2e964736f6c63430008180033";

async function main() {
  const provider = new ethers.JsonRpcProvider(RPC_URL);
  const wallet   = new ethers.Wallet(PRIVATE_KEY, provider);
  const network  = await provider.getNetwork();
  const balance  = await provider.getBalance(wallet.address);

  console.log("\nüåê  PeerRegistry Deploy");
  console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  console.log(`Network:   ${network.name} (chainId: ${network.chainId})`);
  console.log(`Deployer:  ${wallet.address}`);
  console.log(`Balance:   ${ethers.formatEther(balance)} ETH`);

  if (balance < ethers.parseEther("0.001")) {
    console.error("‚ùå Insufficient balance. Need at least 0.001 ETH for deploy.");
    process.exit(1);
  }

  const factory  = new ethers.ContractFactory(ABI, BYTECODE, wallet);
  console.log("\nüì¶ Desplegando PeerRegistry...");
  const contract = await factory.deploy();
  await contract.waitForDeployment();
  const address  = await contract.getAddress();

  console.log(`\n‚úÖ PeerRegistry desplegado`);
  console.log(`   Address:   ${address}`);
  console.log(`   Explorer:  https://sepolia.basescan.org/address/${address}`);

  // Save to addresses.json
  const addressesFile = join(__dirname, "../src/blockchain/addresses.json");
  let addresses = {};
  if (existsSync(addressesFile)) {
    try { addresses = JSON.parse(readFileSync(addressesFile, "utf8")); } catch {}
  }
  addresses["PeerRegistry"] = address;
  writeFileSync(addressesFile, JSON.stringify(addresses, null, 2));
  console.log(`\nüíæ Guardado en src/blockchain/addresses.json`);
  console.log(`   ${JSON.stringify(addresses, null, 2)}`);
}

main().catch(err => { console.error("‚ùå", err.message); process.exit(1); });
